<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange Dynasty ID Card Generator</title>
    <link rel="preload" href="sign.jpeg" as="image">
    <link rel="preload" href="signicon.jpeg" as="image">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Orbitron', sans-serif, 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
            color: #e0e0e0;
        }
        .container {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            position: relative;
            z-index: 1;
            min-height: 100vh;
        }
        .container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 212, 255, 0.1) 0%, transparent 70%);
            z-index: -1;
            animation: pulse 10s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.2; }
            100% { transform: scale(1); opacity: 0.5; }
        }
        .form-container, .preview-container {
            background: rgba(20, 33, 61, 0.9);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            z-index: 2;
            width: 340px;
            border: 2px solid #000000;
            backdrop-filter: blur(5px);
        }
        .form-container:hover, .preview-container:hover {
            transform: translateY(-8px);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
        }
        .form-container h2, .preview-container h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #FF6200;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 98, 0, 0.5);
        }
        .form-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: 700;
            color: #00D4FF;
            text-shadow: 0 0 5px rgba(0, 212, 255, 0.5);
        }
        .form-container input, .form-container select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #FF6200;
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-container select option {
            color: #000000;
        }
        .form-container input:focus, .form-container select:focus {
            outline: none;
            border-color: #00D4FF;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        .form-container input[type="file"] {
            padding: 5px;
        }
        .form-container .error {
            color: #FF6200;
            font-size: 12px;
            margin: -10px 0 10px;
            display: none;
        }
        .form-container button {
            width: 100%;
            padding: 12px;
            background: #FF6200;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(255, 98, 0, 0.5);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        .form-container button:hover {
            background: #e55b00;
            box-shadow: 0 0 15px rgba(255, 98, 0, 0.7);
        }
        .about-btn {
            width: 100%;
            padding: 12px;
            background: #00D4FF;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 5px rgba(0, 212, 255, 0.5);
            transition: background 0.3s ease, box-shadow 0.3s ease;
            margin-top: 15px;
        }
        .about-btn:hover {
            background: #00b0d4;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.7);
        }
        .about-btn:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            position: relative;
            background: rgba(20, 33, 61, 0.9);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
            backdrop-filter: blur(5px);
            text-align: center;
            width: min(500px, 90vw);
        }
        #aboutModal .modal-content {
            max-width: 500px;
            width: 90vw;
            padding: 30px;
        }
        #aboutModal h3 {
            color: #FF6200;
            margin-bottom: 20px;
            text-shadow: 0 0 5px rgba(255, 98, 0, 0.5);
        }
        #aboutModal p {
            font-size: 14px;
            color: #e0e0e0;
            line-height: 1.6;
            margin: 10px 0;
        }
        #aboutModal a {
            color: #00D4FF;
            text-decoration: none;
            text-shadow: 0 0 5px rgba(0, 212, 255, 0.5);
            transition: color 0.3s ease;
        }
        #aboutModal a:hover {
            color: #00b0d4;
            text-decoration: underline;
        }
        .modal-content .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            color: #FF6200;
            cursor: pointer;
            text-shadow: 0 0 5px rgba(255, 98, 0, 0.5);
            transition: color 0.3s ease;
        }
        .modal-content .close-btn:hover {
            color: #e55b00;
        }
        .id-card {
            width: min(400px, 90vw);
            height: min(260px, 58vw);
            border: 3px solid #FF6200;
            background: url('sign.jpeg');
            background-size: cover;
            background-position: center;
            position: relative;
            z-index: 2;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            padding: 15px;
            box-sizing: border-box;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            animation: borderScan 3s infinite;
        }
        @keyframes borderScan {
            0% { border-color: #FF6200; }
            50% { border-color: #00D4FF; }
            100% { border-color: #FF6200; }
        }
        .id-card::before {
            content: none;
        }
        .id-card.download-mode::before {
            content: none;
        }
        .id-card::after {
            content: none;
            display: none;
        }
        .id-card .main-content {
            display: flex;
            flex: 1;
            z-index: 2;
        }
        .id-card .left-column {
            flex: 2;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .id-card .right-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .id-card .top-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            z-index: 2;
        }
        .id-card .name-handle {
            display: flex;
            flex-direction: column;
        }
        .id-card .name {
            font-size: 1.125rem;
            font-weight: 700;
            color: #e0e0e0;
            text-shadow: 0 0 5px #FF6200, 0 0 10px #FF6200, 0 0 15px #00D4FF;
            margin: 0;
            word-wrap: break-word;
            z-index: 2;
        }
        .id-card .handle {
            font-size: 0.875rem;
            color: #00D4FF;
            text-shadow: 0 0 5px #00D4FF, 0 0 10px #00D4FF;
            margin: 5px 0 0 0;
            word-wrap: break-word;
            z-index: 2;
        }
        .id-card .id-number {
            font-size: 0.875rem;
            color: #e0e0e0;
            text-shadow: 0 0 5px #FF6200, 0 0 10px #FF6200;
            z-index: 2;
        }
        .id-card .details p {
            margin: 5px 0;
            font-size: 0.75rem;
            color: #e0e0e0;
            text-shadow: 0 0 5px #00D4FF, 0 0 10px #00D4FF;
            z-index: 2;
            border: 1px solid white;
            padding: 3px 5px;
            border-radius: 4px;
        }
        .id-card .details p span {
            font-weight: 700;
            color: #00D4FF;
        }
        .id-card .details p span.forever-signed {
            color: #ffffff;
            -webkit-text-stroke: 1px #FF6200;
            text-shadow: none;
        }
        .id-card .photo {
            width: 100px;
            height: 120px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #00D4FF;
            border: 2px solid #000000;
            box-shadow: 0 0 15px rgba(255, 98, 0, 0.5);
            z-index: 2;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .id-card .photo:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px #00D4FF;
        }
        .id-card .photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .id-card .barcode {
            width: 100px;
            height: 60px;
            filter: drop-shadow(0 0 12px rgba(0, 212, 255, 0.7));
            z-index: 2;
            transition: transform 0.3s, filter 0.3s;
        }
        .id-card .barcode:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 0 15px #00D4FF);
        }
        .id-card .barcode text {
            font-size: 12px;
            fill: #e0e0e0;
            text-shadow: 0 0 5px #00D4FF;
        }
        .id-card .footer {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            z-index: 2;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }
        .id-card .logo {
            display: flex;
            align-items: center;
            max-width: 100%;
            flex-shrink: 1;
        }
        .id-card .logo img {
            width: 30px;
            height: 30px;
            margin-right: 8px;
            filter: drop-shadow(0 0 12px rgba(255, 98, 0, 0.7));
            flex-shrink: 0;
        }
        .id-card .logo span {
            font-size: 0.875rem;
            font-weight: 700;
            color: #FF6200;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        .preview-container {
            width: 200px;
        }
        .preview-container .id-card {
            transform: scale(0.5);
            transform-origin: top left;
        }
        .button-container {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .share-btn, .direct-share-btn, .download-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(0, 212, 255, 0.5);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        .share-btn {
            background: #00D4FF;
            color: #fff;
        }
        .share-btn:hover {
            background: #00b0d4;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.7);
        }
        .direct-share-btn {
            background: linear-gradient(45deg, #00D4FF, #FF6200);
            color: #fff;
        }
        .direct-share-btn:hover {
            background: linear-gradient(45deg, #00b0d4, #e55b00);
            box-shadow: 0 0 15px rgba(255, 98, 0, 0.7);
        }
        .download-btn {
            background: #FF6200;
            color: #fff;
        }
        .download-btn:hover {
            background: #e55b00;
            box-shadow: 0 0 15px rgba(255, 98, 0, 0.7);
        }
        .share-message {
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
            color: #00D4FF;
            text-shadow: 0 0 5px rgba(0, 212, 255, 0.5);
            font-family: 'Orbitron', sans-serif;
            transition: opacity 0.3s ease;
        }
        .share-message p {
            margin: 0;
            padding: 10px;
            background: rgba(20, 33, 61, 0.9);
            border-radius: 8px;
            border: 1px solid #FF6200;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }
        #cropperModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }
        .cropper-container {
            background: rgba(20, 33, 61, 0.9);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            width: 90vw;
            max-height: 80vh;
            box-sizing: border-box;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        .cropper-container h3 {
            color: #FF6200;
            margin-bottom: 15px;
            text-shadow: 0 0 5px rgba(255, 98, 0, 0.5);
        }
        .cropper-container label {
            display: block;
            margin-bottom: 5px;
            color: #00D4FF;
            font-weight: 700;
        }
        .cropper-container select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #FF6200;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
        }
        .cropper-container select option {
            color: #000000;
        }
        .cropper-image-container {
            max-height: 400px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .cropper-container img {
            max-width: 100%;
            max-height: 400px;
            display: block;
            margin: 0 auto;
        }
        .cropper-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .cropper-container button {
            padding: 10px 20px;
            background: #FF6200;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        .cropper-container button:hover {
            background: #e55b00;
            box-shadow: 0 0 10px rgba(255, 98, 0, 0.7);
        }
        .cropper-container .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            color: #FF6200;
            cursor: pointer;
            text-shadow: 0 0 5px rgba(255, 98, 0, 0.5);
            transition: color 0.3s ease;
        }
        .cropper-container .close-btn:hover {
            color: #e55b00;
        }
        @media (max-width: 400px) {
            .form-container, .preview-container {
                width: 100%;
                padding: 15px;
            }
            .form-container input, .form-container select {
                font-size: 12px;
                padding: 8px;
            }
            .form-container button, .about-btn {
                font-size: 14px;
                padding: 10px;
            }
            .cropper-container {
                padding: 15px;
                max-width: 90vw;
            }
            .cropper-buttons {
                flex-direction: column;
                gap: 8px;
            }
            .share-message {
                font-size: 12px;
                padding: 5px;
            }
            .button-container {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h2>Orange Dynasty</h2>
            <h2>ID Card Generator</h2>
            <label for="name">Name (max 50 chars):</label>
            <input type="text" id="name" placeholder="e.g., David Stone" maxlength="50">
            <span class="error" id="nameError">Name is required</span>
            <label for="xHandle">X Handle:</label>
            <input type="text" id="xHandle" placeholder="e.g., davidstone" maxlength="15" value="@">
            <span class="error" id="xHandleError">Handle must be 1-15 chars after @</span>
            <label for="memberSince">Member Since:</label>
            <select id="memberSince">
                <option value="" disabled selected>Select Year</option>
                <option value="2015">2015</option>
                <option value="2016">2016</option>
                <option value="2017">2017</option>
                <option value="2018">2018</option>
                <option value="2019">2019</option>
                <option value="2020">2020</option>
                <option value="2021">2021</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
            </select>
            <span class="error" id="memberSinceError">Please select a year</span>
            <label for="role">Role (max 50 chars):</label>
            <input type="text" id="role" placeholder="e.g., Serious Builder" maxlength="50">
            <span class="error" id="roleError">Role is required</span>
            <label for="photo">Upload Photo:</label>
            <input type="file" id="photo" accept="image/*">
            <span class="error" id="photoError">Invalid image format</span>
            <button onclick="generateID()">Generate ID Card</button>
            <button class="about-btn" onclick="openAboutModal()" aria-label="About this ID Card Generator">About</button>
        </div>
        <div class="preview-container">
            <h3>Live Preview</h3>
            <div class="id-card preview" id="previewCard">
                <div class="main-content">
                    <div class="left-column">
                        <div class="top-section">
                            <div class="name-handle">
                                <p class="name" id="previewNameDisplay">Name</p>
                                <p class="handle" id="previewXHandleDisplay">@Handle</p>
                            </div>
                            <p class="id-number">ID: <span id="previewIdNumberDisplay">$SIGN</span></p>
                        </div>
                        <div class="details">
                            <p>Member since: <span id="previewMemberSinceDisplay">Year</span></p>
                            <p>Role: <span id="previewRoleDisplay">Role</span></p>
                            <p>Card Issued: <span id="previewIssuedDisplay">YYYY-MM-DD</span></p>
                            <p>Expiration: <span class="forever-signed" id="previewExpirationDisplay">FOREVER SIGNED</span></p>
                        </div>
                    </div>
                    <div class="right-column">
                        <div class="photo" id="previewPhotoDisplay">
                            <span>Photo</span>
                        </div>
                        <svg class="barcode" id="previewBarcode"></svg>
                    </div>
                </div>
                <div class="footer">
                    <div class="logo">
                        <img src="signicon.jpeg" alt="Sign Icon" loading="lazy">
                        <span id="previewCommunityDisplay">Orange Dynasty</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal" role="dialog" aria-label="ID Card Preview">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()" aria-label="Close">×</span>
            <div class="id-card" id="idCard">
                <div class="main-content">
                    <div class="left-column">
                        <div class="top-section">
                            <div class="name-handle">
                                <p class="name" id="nameDisplay"></p>
                                <p class="handle" id="xHandleDisplay"></p>
                            </div>
                            <p class="id-number">ID: <span id="idNumberDisplay">$SIGN</span></p>
                        </div>
                        <div class="details">
                            <p>Member since: <span id="memberSinceDisplay"></span></p>
                            <p>Role: <span id="roleDisplay"></span></p>
                            <p>Card Issued: <span id="issuedDisplay"></span></p>
                            <p>Expiration: <span class="forever-signed" id="expirationDisplay"></span></p>
                        </div>
                    </div>
                    <div class="right-column">
                        <div class="photo" id="photoDisplay">
                            <span>Photo Placeholder</span>
                        </div>
                        <svg class="barcode" id="barcode"></svg>
                    </div>
                </div>
                <div class="footer">
                    <div class="logo">
                        <img src="signicon.jpeg" alt="Sign Icon" loading="lazy">
                        <span id="communityDisplay">Orange Dynasty</span>
                    </div>
                </div>
            </div>
            <div class="button-container">
                <button class="share-btn" onclick="shareOnTwitter()">Copy Share Message</button>
                <button class="direct-share-btn" onclick="directShareOnTwitter()">Share to X (Twitter)</button>
                <button class="download-btn" onclick="downloadImage()">Download PNG</button>
            </div>
            <div class="share-message" id="shareMessage" style="display: none;">
                <p>Message copied! Share it on X (Twitter) with your downloaded ID card image.</p>
            </div>
        </div>
    </div>

    <div class="modal" id="cropperModal" role="dialog" aria-label="Image Cropper">
        <div class="cropper-container">
            <span class="close-btn" onclick="closeModal()" aria-label="Close">×</span>
            <h3>Crop Your Image</h3>
            <label for="aspectRatio">Aspect Ratio:</label>
            <select id="aspectRatio" onchange="updateAspectRatio()">
                <option value="100/120" selected>ID Card (100:120)</option>
                <option value="1">Square (1:1)</option>
                <option value="0">Freeform</option>
            </select>
            <div class="cropper-image-container">
                <img id="imageToCrop" src="">
            </div>
            <div class="cropper-buttons">
                <button onclick="cropImage()">Crop & Use</button>
            </div>
        </div>
    </div>

    <div class="modal" id="aboutModal" role="dialog" aria-label="About ID Card Generator">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAboutModal()" aria-label="Close">×</span>
            <h3>About Orange Dynasty ID Generator</h3>
            <p>
                This ID card generator is a fan-made project, not official from the Sign Protocol team <a href="https://x.com/sign" target="_blank" rel="noopener">(@Sign)</a>. It’s all for fun — no rewards or perks guaranteed!
            </p>
            <p>
                Orange Dynasty ID generator is built by <a href="https://x.com/ChrisGold__" target="_blank" rel="noopener">Chris Gold</a> and <a href="https://x.com/PrinceWarexy" target="_blank" rel="noopener">Ọlá (blue tick)</a> for the Orange Dynasty community as a fun, creative project to celebrate Sign's vision of verifiable trust.</a>.
            </p>
            <p>
                Generating an ID card is purely for entertainment and does not entitle or guarantee any rewards, recognition, or benefits from <a href="https://x.com/sign" target="_blank" rel="noopener">Sign</a>.
            </p>
        </div>
    </div>

    <script defer src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js" onerror="handleScriptError('JsBarcode')"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.js" onerror="handleScriptError('CropperJS')"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" onerror="handleScriptError('html2canvas')"></script>
    <script>
        let cropper;
        let croppedImageData;

        function handleScriptError(scriptName) {
            alert(`Failed to load ${scriptName}. Please check your internet connection or try again later.`);
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function generateUniqueId() {
            return '$SIGN';
        }

        function validateInputs() {
            const name = document.getElementById('name').value;
            const xHandle = document.getElementById('xHandle').value;
            const memberSince = document.getElementById('memberSince').value;
            const role = document.getElementById('role').value;
            const handleRegex = /^@[A-Za-z0-9_]{1,15}$/;

            let isValid = true;
            document.querySelectorAll('.error').forEach(e => e.style.display = 'none');

            if (!name) {
                document.getElementById('nameError').style.display = 'block';
                isValid = false;
            }
            if (!xHandle || !handleRegex.test(xHandle)) {
                document.getElementById('xHandleError').style.display = 'block';
                isValid = false;
            }
            if (!memberSince) {
                document.getElementById('memberSinceError').style.display = 'block';
                isValid = false;
            }
            if (!role) {
                document.getElementById('roleError').style.display = 'block';
                isValid = false;
            }

            return isValid;
        }

        function updatePreview() {
            const name = document.getElementById('name').value || 'Name';
            const xHandle = document.getElementById('xHandle').value || '@Handle';
            const memberSince = document.getElementById('memberSince').value || 'Year';
            const role = document.getElementById('role').value || 'Role';

            const previewCard = document.getElementById('previewCard');
            document.getElementById('previewNameDisplay').textContent = name;
            document.getElementById('previewXHandleDisplay').textContent = xHandle;
            document.getElementById('previewIdNumberDisplay').textContent = '$SIGN';
            document.getElementById('previewMemberSinceDisplay').textContent = memberSince;
            document.getElementById('previewRoleDisplay').textContent = role;
            document.getElementById('previewIssuedDisplay').textContent = formatDate(new Date());
            document.getElementById('previewExpirationDisplay').textContent = 'FOREVER SIGNED';
            document.getElementById('previewCommunityDisplay').textContent = 'Orange Dynasty';

            const photoDisplay = document.getElementById('previewPhotoDisplay');
            photoDisplay.innerHTML = croppedImageData ? `<img src="${croppedImageData}">` : '<span>Photo</span>';

            if (typeof JsBarcode !== 'undefined') {
                JsBarcode("#previewBarcode", generateUniqueId(), {
                    format: "CODE128",
                    width: 2,
                    height: 40,
                    displayValue: true,
                    fontSize: 12,
                    font: 'Orbitron',
                    textMargin: 2
                });
            }
        }

        function generateID() {
            try {
                if (!validateInputs()) {
                    alert('Please correct the errors in the form.');
                    return;
                }

                const name = document.getElementById('name').value;
                const xHandle = document.getElementById('xHandle').value;
                const memberSince = document.getElementById('memberSince').value;
                const role = document.getElementById('role').value;

                const barcodeContent = generateUniqueId();
                const formattedIssued = formatDate(new Date());
                const expiration = 'FOREVER SIGNED';
                const community = 'Orange Dynasty';

                const idCard = document.getElementById('idCard');
                document.getElementById('nameDisplay').textContent = name;
                document.getElementById('xHandleDisplay').textContent = xHandle;
                document.getElementById('idNumberDisplay').textContent = '$SIGN';
                document.getElementById('memberSinceDisplay').textContent = memberSince;
                document.getElementById('roleDisplay').textContent = role;
                document.getElementById('issuedDisplay').textContent = formattedIssued;
                document.getElementById('expirationDisplay').textContent = expiration;
                document.getElementById('communityDisplay').textContent = community;

                const photoDisplay = document.getElementById('photoDisplay');
                photoDisplay.innerHTML = croppedImageData ? `<img src="${croppedImageData}">` : '<span>Photo Placeholder</span>';

                if (typeof JsBarcode === 'undefined') {
                    alert('Barcode library not loaded. Please refresh the page or check your connection.');
                    return;
                }

                JsBarcode("#barcode", barcodeContent, {
                    format: "CODE128",
                    width: 2,
                    height: 40,
                    displayValue: true,
                    fontSize: 12,
                    font: 'Orbitron',
                    textMargin: 2
                });

                const modal = document.getElementById('modal');
                if (modal) {
                    modal.style.display = 'flex';
                    updateShareableLink(name, xHandle, memberSince, role);
                } else {
                    alert('Error: Modal element not found.');
                }
            } catch (error) {
                console.error('Error generating ID card:', error);
                alert('An error occurred while generating the ID card: ' + error.message);
            }
        }

        function openAboutModal() {
            const aboutModal = document.getElementById('aboutModal');
            if (aboutModal) {
                aboutModal.style.display = 'flex';
            }
        }

        function closeAboutModal() {
            const aboutModal = document.getElementById('aboutModal');
            if (aboutModal) {
                aboutModal.style.display = 'none';
            }
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            const cropperModal = document.getElementById('cropperModal');
            const aboutModal = document.getElementById('aboutModal');
            if (modal) {
                modal.style.display = 'none';
                document.getElementById('shareMessage').style.display = 'none';
            }
            if (cropperModal) {
                cropperModal.style.display = 'none';
            }
            if (aboutModal) {
                aboutModal.style.display = 'none';
            }
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }

        function shareOnTwitter() {
            const shareMessage = "#FuturisticID #SignGlobal";
            const shareMessageElement = document.getElementById('shareMessage');

            navigator.clipboard.writeText(shareMessage).then(() => {
                shareMessageElement.style.display = 'block';
                setTimeout(() => {
                    shareMessageElement.style.display = 'none';
                }, 5000);
            }).catch(error => {
                console.error('Error copying to clipboard:', error);
                alert('Failed to copy share message. Please copy this manually: ' + shareMessage);
            });
        }

        function directShareOnTwitter() {
            const tweetText = "Just created my Orange Dynasty ID card! for fun and to celebrate @Sign's vision of verifiable trust. Join the movement! 🧡🟠🧡🟠 #SignID $SIGN" ;
            const encodedText = encodeURIComponent(tweetText);
            const tweetUrl = `https://x.com/intent/tweet?text=${encodedText}`;
            window.open(tweetUrl, '_blank');
        }

        function downloadImage() {
            const idCard = document.getElementById('idCard');
            const name = document.getElementById('name').value || 'id-card';

            idCard.classList.add('download-mode');
            document.fonts.ready.then(() => {
                html2canvas(idCard, {
                    backgroundColor: null,
                    useCORS: true,
                    width: 400,
                    height: 260,
                    scale: 2
                }).then(canvas => {
                    idCard.classList.remove('download-mode');
                    const imageData = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = imageData;
                    link.download = `${name}-id-card.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }).catch(error => {
                    console.error('Error capturing ID card image for download:', error);
                    idCard.classList.remove('download-mode');
                    alert('Failed to download ID card image. Please check your connection or try again.');
                });
            });
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageToCrop = document.getElementById('imageToCrop');
                    imageToCrop.src = e.target.result;
                    document.getElementById('cropperModal').style.display = 'flex';
                    if (cropper) cropper.destroy();
                    const aspectRatio = getSelectedAspectRatio();
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: aspectRatio,
                        viewMode: 1,
                        autoCropArea: 0.8,
                        responsive: true,
                        ready: function() {
                            this.cropper.setCropBoxData({
                                width: Math.min(300, this.cropper.getContainerData().width),
                                height: Math.min(360, this.cropper.getContainerData().height)
                            });
                        }
                    });
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('photoError').style.display = 'block';
            }
        }

        function getSelectedAspectRatio() {
            const select = document.getElementById('aspectRatio');
            const value = select.value;
            if (value === '100/120') return 100 / 120;
            if (value === '1') return 1;
            return NaN;
        }

        function updateAspectRatio() {
            if (cropper) {
                const aspectRatio = getSelectedAspectRatio();
                cropper.setAspectRatio(aspectRatio);
            }
        }

        function cropImage() {
            if (cropper) {
                croppedImageData = cropper.getCroppedCanvas({ width: 100, height: 120 }).toDataURL('image/png');
                updatePreview();
                closeModal();
            }
        }

        function updateShareableLink(name, xHandle, memberSince, role) {
            const params = new URLSearchParams({
                name,
                xHandle,
                memberSince,
                role
            });
            const newUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            window.history.replaceState(null, '', newUrl);
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            const name = params.get('name') || '';
            const xHandle = params.get('xHandle') || '@';
            const memberSince = params.get('memberSince') || '';
            const role = params.get('role') || '';

            document.getElementById('name').value = name;
            document.getElementById('xHandle').value = xHandle;
            document.getElementById('memberSince').value = memberSince;
            document.getElementById('role').value = role;
            updatePreview();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadFromURL();
            document.querySelectorAll('#name, #xHandle, #memberSince, #role').forEach(input => {
                input.addEventListener('input', updatePreview);
            });
            document.getElementById('photo').addEventListener('change', handlePhotoUpload);
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape' && (
                    document.getElementById('modal').style.display === 'flex' ||
                    document.getElementById('cropperModal').style.display === 'flex' ||
                    document.getElementById('aboutModal').style.display === 'flex'
                )) {
                    closeModal();
                }
            });
            document.getElementById('xHandle').addEventListener('input', function() {
                if (!this.value.startsWith('@')) {
                    this.value = '@' + this.value.replace(/^@+/, '');
                }
            });
        });
    </script>
</body>
</html>
